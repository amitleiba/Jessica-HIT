version: "3.8"

# ============================================
# Shared JWT config — MUST match between
# AuthService (signs tokens) and Gateway (validates tokens)
# ============================================
x-jwt-env: &jwt-env
  Jwt__SecretKey: "JessicaSuperSecretKeyThatIsAtLeast32CharactersLong!!2026"
  Jwt__Issuer: "jessica-auth"
  Jwt__Audience: "jessica-api"
  Jwt__AccessTokenExpiryMinutes: "15"
  Jwt__RefreshTokenExpiryDays: "7"

services:
  # ============================================
  # GATEWAY — Reverse proxy (YARP) + JWT validation
  # ============================================
  gateway:
    image: ${DOCKER_REGISTRY-}gateway
    build:
      context: .
      dockerfile: Gateway/Dockerfile
    ports:
      - "5207:8080"
      - "7215:8081"
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_HTTP_PORTS: "8080"
      ASPNETCORE_HTTPS_PORTS: "8081"
      <<: *jwt-env
      # YARP cluster addresses — use docker-compose service names
      ReverseProxy__Clusters__auth-service-cluster__Destinations__destination1__Address: "http://authservice:8080"
      ReverseProxy__Clusters__jessica-manager-cluster__Destinations__destination1__Address: "http://jessicamanager:8080"
    depends_on:
      authservice:
        condition: service_started
      jessicamanager:
        condition: service_started
    networks:
      - jessica-network

  # ============================================
  # AUTHSERVICE — User management + token generation
  # ============================================
  authservice:
    image: ${DOCKER_REGISTRY-}authservice
    build:
      context: .
      dockerfile: AuthService/Dockerfile
    ports:
      - "5100:8080"
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_HTTP_PORTS: "8080"
      <<: *jwt-env
      ConnectionStrings__AuthDb: "Host=postgres-auth;Port=5432;Database=jessica_auth;Username=auth_user;Password=auth_password"
      Crypto__WorkFactor: "12"
    depends_on:
      postgres-auth:
        condition: service_healthy
    networks:
      - jessica-network

  # ============================================
  # JESSICA MANAGER — Business logic service
  # ============================================
  jessicamanager:
    image: ${DOCKER_REGISTRY-}jessicamanager
    build:
      context: .
      dockerfile: JessicaManager/Dockerfile
    ports:
      - "5000:8080"
      - "5001:8081"
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_HTTP_PORTS: "8080"
      ASPNETCORE_HTTPS_PORTS: "8081"
    networks:
      - jessica-network

  # ============================================
  # KAFKA - COMMENTED OUT (Not needed for now)
  # ============================================
  # kafka:
  #   image: confluentinc/cp-kafka:latest
  #   container_name: kafka
  #   ports:
  #     - "9092:9092"
  #   environment:
  #     - KAFKA_NODE_ID=1
  #     - KAFKA_PROCESS_ROLES=broker,controller
  #     - KAFKA_CONTROLLER_QUORUM_VOTERS=1@kafka:29093
  #     - KAFKA_LISTENERS=PLAINTEXT://:9092,CONTROLLER://:29093,EXTERNAL://:9094
  #     - KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://kafka:9092,EXTERNAL://localhost:9094
  #     - KAFKA_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,EXTERNAL:PLAINTEXT,PLAINTEXT:PLAINTEXT
  #     - KAFKA_INTER_BROKER_LISTENER_NAME=PLAINTEXT
  #     - KAFKA_CONTROLLER_LISTENER_NAMES=CONTROLLER
  #     - KAFKA_LOG_DIRS=/var/lib/kafka/data
  #     - KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR=1
  #     - KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR=1
  #     - KAFKA_TRANSACTION_STATE_LOG_MIN_ISR=1
  #     - CLUSTER_ID=MkU3OEVBNTcwNTJENDM2Qk
  #   volumes:
  #     - kafka-data:/var/lib/kafka/data
  #   networks:
  #     - jessica-network
  #   restart: unless-stopped
  #   healthcheck:
  #     test:
  #       [
  #         "CMD-SHELL",
  #         "kafka-broker-api-versions.sh --bootstrap-server localhost:9092 || exit 1",
  #       ]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 5
  #     start_period: 60s

  # kafka-ui:
  #   image: provectuslabs/kafka-ui:latest
  #   container_name: kafka-ui
  #   ports:
  #     - "8081:8080"
  #   environment:
  #     - KAFKA_CLUSTERS_0_NAME=local
  #     - KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS=kafka:9092
  #   networks:
  #     - jessica-network
  #   depends_on:
  #     - kafka
  #   restart: unless-stopped

  # ============================================
  # POSTGRES — AuthService database
  # ============================================
  postgres-auth:
    image: postgres:16-alpine
    container_name: postgres-auth
    environment:
      POSTGRES_DB: jessica_auth
      POSTGRES_USER: auth_user
      POSTGRES_PASSWORD: auth_password
    volumes:
      - postgres-auth-data:/var/lib/postgresql/data
    ports:
      - "5433:5432"
    networks:
      - jessica-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U auth_user -d jessica_auth"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  # kafka-data:  # Commented out - Kafka not in use
  postgres-auth-data:

networks:
  jessica-network:
    driver: bridge
